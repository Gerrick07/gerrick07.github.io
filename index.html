<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engineer's Project Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .sidebar { transition: width 0.3s ease; }
        .sidebar.collapsed { width: 4.5rem; }
        .sidebar.collapsed .sidebar-text { display: none; }
        .sidebar.collapsed .sidebar-logo-text { display: none; }
        .sidebar.collapsed .sidebar-footer-text { display: none; }
        .sidebar:not(.collapsed) { width: 16rem; }
        .kanban-column {
            min-width: 280px;
            width: 280px;
        }
        .gantt-bar {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="flex h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar bg-gray-800 text-white flex flex-col p-4 shadow-lg">
            <div class="flex items-center mb-8">
                <span class="p-2 bg-indigo-500 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg>
                </span>
                <h1 class="text-xl font-bold ml-3 sidebar-logo-text">EngiTrack</h1>
            </div>
            
            <nav class="flex-1 space-y-2">
                <a href="#" class="nav-item flex items-center p-2 rounded-lg text-gray-300 hover:bg-gray-700" data-view="dashboard">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                    <span class="ml-4 sidebar-text">Dashboard</span>
                </a>
                <a href="#" class="nav-item flex items-center p-2 rounded-lg text-gray-300 hover:bg-gray-700" data-view="projects">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
                    <span class="ml-4 sidebar-text">Projects</span>
                </a>
                <a href="#" class="nav-item flex items-center p-2 rounded-lg text-gray-300 hover:bg-gray-700" data-view="calendar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span class="ml-4 sidebar-text">Calendar</span>
                </a>
                 <a href="#" class="nav-item flex items-center p-2 rounded-lg text-gray-300 hover:bg-gray-700" data-view="clients">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    <span class="ml-4 sidebar-text">Clients</span>
                </a>
            </nav>

            <div class="mt-auto">
                <button id="toggleSidebar" class="flex items-center p-2 rounded-lg text-gray-400 hover:bg-gray-700 w-full">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line></svg>
                    <span class="ml-4 sidebar-text sidebar-footer-text">Collapse</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 p-8 overflow-y-auto">
            <!-- Initial Loading Spinner -->
            <div id="initial-loader" class="flex flex-col items-center justify-center h-full">
                <div class="loader"></div>
                <p class="mt-4 text-gray-600">Connecting to database...</p>
            </div>
            <!-- Views will be injected here -->
        </main>
    </div>

    <!-- Modal for adding/editing projects -->
    <div id="project-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">New Project</h2>
            <form id="project-form">
                <input type="hidden" id="projectId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="projectName" class="block text-sm font-medium text-gray-700">Project Name</label>
                        <input type="text" id="projectName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="projectClient" class="block text-sm font-medium text-gray-700">Client</label>
                        <select id="projectClient" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                           <!-- Client options will be populated here -->
                        </select>
                    </div>
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-700">Start Date</label>
                        <input type="date" id="startDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-700">End Date</label>
                        <input type="date" id="endDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="projectDescription" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="projectDescription" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" id="cancel-project" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Save Project</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Generic Modal for simple inputs -->
    <div id="generic-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 id="generic-modal-title" class="text-2xl font-bold mb-6"></h2>
            <form id="generic-form">
                <input type="hidden" id="generic-edit-id">
                <div id="generic-modal-body"></div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" id="cancel-generic" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" id="generic-submit-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Add</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Custom Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm">
            <h2 id="confirm-modal-title" class="text-lg font-bold mb-4">Are you sure?</h2>
            <p id="confirm-modal-text" class="text-gray-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="confirm-ok-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, setDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {

            // --- STATE MANAGEMENT ---
            let state = {
                currentView: 'dashboard',
                selectedProjectId: null,
                activeTab: 'overview',
                sidebarCollapsed: false,
                projects: [],
                clients: [],
                userId: null,
                isLoading: true,
            };

            // --- FIREBASE SETUP ---
            // =================================================================================
            // IMPORTANT: PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE
            // Replace the placeholder values with the actual keys from your Firebase project.
            // =================================================================================
            const firebaseConfig = {
                apiKey: "AIzaSyBfrp8zXq-FM7uEr0ti0LakRE4h5JE7DJ8",
                authDomain: "engitrack-system.firebaseapp.com",
                projectId: "engitrack-system",
                storageBucket: "engitrack-system.firebasestorage.app",
                messagingSenderId: "817007267288",
                appId: "1:817007267288:web:208e1730a1864f1a5936ad",
                measurementId: "G-GS5SKNC9Q9"
            };
            
            // This is a placeholder for a specific environment variable
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            let db, auth;
            let unsubscribeProjects = () => {};
            let unsubscribeClients = () => {};

            async function initializeFirebase() {
                try {
                    // Check if the config has been filled out
                    if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                        document.getElementById('main-content').innerHTML = `
                            <div class="text-center h-full flex flex-col justify-center">
                                <h1 class="text-2xl font-bold text-red-600 mb-4">Configuration Needed</h1>
                                <p class="text-gray-700">Please paste your Firebase project configuration into the HTML file to connect the application to the database.</p>
                            </div>
                        `;
                        return;
                    }
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    onAuthStateChanged(auth, user => {
                        if (user) {
                            state.userId = user.uid;
                            setupRealtimeListeners();
                        } else {
                            // If __initial_auth_token is provided by the environment, use it. Otherwise, sign in anonymously.
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                signInAnonymously(auth);
                            }
                        }
                    });
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    document.getElementById('main-content').innerHTML = `<div class="text-red-500 font-bold text-center h-full flex flex-col justify-center">Error: Could not connect to the database.<br>Please ensure your Firebase configuration is correct and you have enabled anonymous authentication. <br><br> <span class="text-sm text-gray-600">Error details: ${error.message}</span></div>`;
                }
            }
            
            function setupRealtimeListeners() {
                if (!state.userId) return;

                // Unsubscribe from old listeners before creating new ones
                unsubscribeProjects();
                unsubscribeClients();
                
                const projectsCollection = collection(db, 'artifacts', appId, 'users', state.userId, 'projects');
                unsubscribeProjects = onSnapshot(projectsCollection, (snapshot) => {
                    state.projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    state.isLoading = false; // Data has loaded
                    render();
                }, (error) => {
                    console.error("Error fetching projects:", error);
                    mainContent.innerHTML = `<div class="text-red-500 font-bold">Error loading projects. Check Firestore rules and database setup.</div>`;
                });

                const clientsCollection = collection(db, 'artifacts', appId, 'users', state.userId, 'clients');
                unsubscribeClients = onSnapshot(clientsCollection, (snapshot) => {
                    state.clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    render();
                }, (error) => {
                    console.error("Error fetching clients:", error);
                });
            }


            const mainContent = document.getElementById('main-content');
            const navItems = document.querySelectorAll('.nav-item');
            
            // --- AUTOMATED PROGRESS CALCULATION ---
            function calculateProjectProgress(project) {
                if (!project) return 0;
                const totalTasks = project.tasks?.length || 0;
                const doneTasks = project.tasks?.filter(t => t.status === 'done').length || 0;
                const taskProgress = totalTasks > 0 ? (doneTasks / totalTasks) : 0;
                const totalSubmissions = project.submissions?.length || 0;
                const approvedSubmissions = project.submissions?.filter(s => s.status === 'Approved').length || 0;
                const submissionProgress = totalSubmissions > 0 ? (approvedSubmissions / totalSubmissions) : 0;
                let finalProgress = 0;
                if (totalTasks > 0 && totalSubmissions > 0) {
                    finalProgress = (taskProgress * 0.7) + (submissionProgress * 0.3);
                } else if (totalTasks > 0) {
                    finalProgress = taskProgress;
                } else if (totalSubmissions > 0) {
                    finalProgress = submissionProgress;
                }
                return Math.round(finalProgress * 100);
            }

            async function updateProjectProgress(projectId) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const newProgress = calculateProjectProgress(project);
                    if (project.progress !== newProgress) {
                        const projectRef = doc(db, 'artifacts', appId, 'users', state.userId, 'projects', projectId);
                        await setDoc(projectRef, { progress: newProgress }, { merge: true });
                    }
                }
            }


            // --- ROUTING / VIEW MANAGEMENT ---
            function navigate(view, projectId = null) {
                if (view === 'projectDetail' && state.selectedProjectId !== projectId) {
                    state.activeTab = 'overview';
                }
                state.currentView = view;
                state.selectedProjectId = projectId;
                render();
            }
            
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigate(item.dataset.view);
                });
            });

            function updateActiveNav() {
                navItems.forEach(item => {
                    const view = state.currentView === 'projectDetail' ? 'projects' : state.currentView;
                    if (item.dataset.view === view) {
                        item.classList.add('bg-gray-700', 'text-white');
                        item.classList.remove('text-gray-300');
                    } else {
                        item.classList.remove('bg-gray-700', 'text-white');
                        item.classList.add('text-gray-300');
                    }
                });
            }

            // --- RENDERING ---
            function render() {
                updateActiveNav();
                mainContent.innerHTML = ''; // Clear previous content

                if (state.isLoading) {
                    mainContent.innerHTML = `
                        <div id="initial-loader" class="flex flex-col items-center justify-center h-full">
                            <div class="loader"></div>
                            <p class="mt-4 text-gray-600">Loading your data...</p>
                        </div>
                    `;
                    return;
                }
                
                switch (state.currentView) {
                    case 'dashboard':
                        mainContent.appendChild(renderDashboard());
                        renderDashboardCharts();
                        break;
                    case 'projects':
                        mainContent.appendChild(renderProjectList());
                        break;
                    case 'projectDetail':
                        mainContent.appendChild(renderProjectDetail());
                        break;
                    case 'calendar':
                        mainContent.appendChild(renderCalendar());
                        break;
                    case 'clients':
                        mainContent.appendChild(renderClients());
                        break;
                }
            }

            // --- VIEW TEMPLATES ---
            function renderDashboard() {
                const el = document.createElement('div');
                const ongoingProjects = state.projects.filter(p => p.progress < 100).length;
                const upcomingDeadlines = state.projects.filter(p => {
                    const diff = new Date(p.endDate) - new Date();
                    return diff > 0 && diff < (30 * 24 * 60 * 60 * 1000);
                }).length;

                el.innerHTML = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h1>
                    
                    <div class="flex flex-col lg:flex-row gap-6">
                        <!-- Chart -->
                        <div class="lg:w-1/3 bg-white p-6 rounded-lg shadow-md">
                            <h3 class="font-semibold text-gray-700 mb-4">Project Status Overview</h3>
                            <div class="h-64">
                                <canvas id="projectStatusChart"></canvas>
                            </div>
                        </div>

                        <!-- Stats Cards -->
                        <div class="lg:w-2/3 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-gray-500 font-medium">Total Projects</h3>
                                <p class="text-3xl font-bold text-gray-800">${state.projects.length}</p>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-gray-500 font-medium">Ongoing Projects</h3>
                                <p class="text-3xl font-bold text-indigo-600">${ongoingProjects}</p>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-gray-500 font-medium">Upcoming Deadlines (30d)</h3>
                                <p class="text-3xl font-bold text-amber-600">${upcomingDeadlines}</p>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-gray-500 font-medium">Total Clients</h3>
                                <p class="text-3xl font-bold text-gray-800">${state.clients.length}</p>
                            </div>
                        </div>
                    </div>
                `;
                return el;
            }
            
            function renderDashboardCharts() {
                const statusCtx = document.getElementById('projectStatusChart')?.getContext('2d');
                if(statusCtx) {
                    const todo = state.projects.filter(p => p.progress === 0).length;
                    const inProgress = state.projects.filter(p => p.progress > 0 && p.progress < 100).length;
                    const completed = state.projects.filter(p => p.progress === 100).length;

                    new Chart(statusCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Not Started', 'In Progress', 'Completed'],
                            datasets: [{
                                data: [todo, inProgress, completed],
                                backgroundColor: ['#9ca3af', '#4f46e5', '#10b981'],
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
            }

            function renderProjectList() {
                const el = document.createElement('div');
                el.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-800">Projects</h1>
                        <button id="add-project-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md shadow hover:bg-indigo-700 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            New Project
                        </button>
                    </div>
                    <div class="bg-white rounded-lg shadow-md overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600 whitespace-nowrap">Project Name</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600 whitespace-nowrap">Client</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600 whitespace-nowrap">End Date</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600 whitespace-nowrap">Progress</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600 whitespace-nowrap">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${state.projects.map(p => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="p-4 font-medium text-gray-800">${p.name}</td>
                                        <td class="p-4 text-gray-600">${state.clients.find(c => c.id === p.clientId)?.name || 'N/A'}</td>
                                        <td class="p-4 text-gray-600">${p.endDate}</td>
                                        <td class="p-4 min-w-[150px]">
                                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                                <div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${p.progress}%"></div>
                                            </div>
                                            <span class="text-xs text-gray-500">${p.progress}%</span>
                                        </td>
                                        <td class="p-4">
                                            <button class="view-project text-indigo-600 hover:underline" data-id="${p.id}">View</button>
                                        </td>
                                    </tr>
                                `).join('')}
                                ${state.projects.length === 0 ? `<tr><td colspan="5" class="p-4 text-center text-gray-500">No projects found.</td></tr>` : ''}
                            </tbody>
                        </table>
                    </div>
                `;
                el.querySelector('#add-project-btn').addEventListener('click', () => openProjectModal());
                el.querySelectorAll('.view-project').forEach(btn => {
                    btn.addEventListener('click', (e) => navigate('projectDetail', e.target.dataset.id));
                });
                return el;
            }

            function renderProjectDetail() {
                const project = state.projects.find(p => p.id === state.selectedProjectId);
                if (!project) {
                    const el = document.createElement('div');
                    el.innerHTML = `<p class="text-red-500">Project not found.</p>`;
                    return el;
                }
                const client = state.clients.find(c => c.id === project.clientId);

                const el = document.createElement('div');
                el.innerHTML = `
                    <div class="mb-6">
                        <button id="back-to-projects" class="text-indigo-600 hover:underline mb-4 flex items-center">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                            Back to Projects
                        </button>
                        <div class="flex justify-between items-start">
                             <div>
                                <h1 class="text-3xl font-bold text-gray-800">${project.name}</h1>
                                <p class="text-gray-500">Client: ${client?.name || 'N/A'}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button id="edit-project-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">Edit</button>
                                <button id="delete-project-btn" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">Delete</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabs -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav id="project-tabs" class="-mb-px flex space-x-6 overflow-x-auto">
                            <a href="#" class="project-tab py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600 whitespace-nowrap" data-tab="overview">Overview</a>
                            <a href="#" class="project-tab py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap" data-tab="documentation">Documentation</a>
                            <a href="#" class="project-tab py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap" data-tab="schedule">Schedule</a>
                            <a href="#" class="project-tab py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap" data-tab="progress">Site Progress</a>
                            <a href="#" class="project-tab py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap" data-tab="submissions">Submissions</a>
                            <a href="#" class="project-tab py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap" data-tab="notes">Notes</a>
                        </nav>
                    </div>
                    
                    <div id="project-tab-content">
                       <!-- Content injected here -->
                    </div>
                `;

                // Event Listeners
                el.querySelector('#back-to-projects').addEventListener('click', () => navigate('projects'));
                el.querySelector('#edit-project-btn').addEventListener('click', () => openProjectModal(project.id));
                el.querySelector('#delete-project-btn').addEventListener('click', async () => {
                    showConfirm('Delete Project?', 'Are you sure you want to delete this project?', async () => {
                        const projectRef = doc(db, 'artifacts', appId, 'users', state.userId, 'projects', project.id);
                        await deleteDoc(projectRef);
                        navigate('projects');
                    });
                });

                const tabContent = el.querySelector('#project-tab-content');
                
                function renderTab(tabName) {
                    state.activeTab = tabName;
                    el.querySelectorAll('.project-tab').forEach(t => {
                        if(t.dataset.tab === tabName) {
                             t.classList.add('border-indigo-500', 'text-indigo-600');
                             t.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                        } else {
                            t.classList.remove('border-indigo-500', 'text-indigo-600');
                            t.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                        }
                    });
                    
                    tabContent.innerHTML = '';
                    let tabElement;
                    switch(tabName) {
                        case 'overview': tabElement = renderProjectOverview(project); break;
                        case 'documentation': tabElement = renderProjectDocumentation(project); break;
                        case 'schedule': tabElement = renderProjectSchedule(project); break;
                        case 'progress': tabElement = renderProjectProgress(project); break;
                        case 'submissions': tabElement = renderProjectSubmissions(project); break;
                        case 'notes': tabElement = renderProjectNotes(project); break;
                    }
                    if (tabElement) {
                        tabContent.appendChild(tabElement);
                    }
                    attachTabEventListeners(tabName, project);
                }
                
                el.querySelectorAll('.project-tab').forEach(tab => {
                    tab.addEventListener('click', e => {
                        e.preventDefault();
                        renderTab(tab.dataset.tab);
                    });
                });
                
                // Initial tab render
                renderTab(state.activeTab);

                return el;
            }
            
            function attachTabEventListeners(tabName, project) {
                switch(tabName) {
                    case 'documentation':
                        document.getElementById('add-document-btn')?.addEventListener('click', () => {
                            openGenericModal('New Document', [
                                {label: 'Document Name', id: 'docName', type: 'text', required: true},
                                {label: 'Document Type', id: 'docType', type: 'text', placeholder: 'e.g., Drawing, Report'},
                                {label: 'Date', id: 'docDate', type: 'date', required: true},
                                {label: 'Attach File (optional)', id: 'docFile', type: 'file'},
                            ], async (formData, id) => {
                                const projectRef = doc(db, 'artifacts', appId, 'users', state.userId, 'projects', project.id);
                                const updatedDocs = project.documents ? [...project.documents] : [];

                                if (id) {
                                    const docIndex = updatedDocs.findIndex(d => d.id === id);
                                    if(docIndex > -1) {
                                        updatedDocs[docIndex].name = formData.docName;
                                        updatedDocs[docIndex].type = formData.docType;
                                        updatedDocs[docIndex].date = formData.docDate;
                                        if (formData.docFile.name) updatedDocs[docIndex].fileName = formData.docFile.name;
                                    }
                                } else {
                                    const newDoc = { id: 'd' + Date.now(), name: formData.docName, type: formData.docType, date: formData.docDate, fileName: formData.docFile.name || '' };
                                    updatedDocs.push(newDoc);
                                }
                                await setDoc(projectRef, { documents: updatedDocs }, { merge: true });
                            });
                        });
                        break;
                    case 'progress':
                        document.getElementById('add-task-btn')?.addEventListener('click', () => {
                             openGenericModal('New Task', [
                                {label: 'Task Title', id: 'taskTitle', type: 'text', required: true},
                                {label: 'Assigned To', id: 'taskAssigned', type: 'text'},
                                {label: 'Start Date', id: 'taskStartDate', type: 'date'},
                                {label: 'End Date', id: 'taskEndDate', type: 'date'},
                                {label: 'Status', id: 'taskStatus', type: 'select', options: ['todo', 'inprogress', 'done']},
                            ], async (formData, id) => {
                                const projectRef = doc(db, 'artifacts', appId, 'users', state.userId, 'projects', project.id);
                                const updatedTasks = project.tasks ? [...project.tasks] : [];
                                if (id) {
                                    const taskIndex = updatedTasks.findIndex(t => t.id === id);
                                    if(taskIndex > -1) {
                                        updatedTasks[taskIndex] = {...updatedTasks[taskIndex], title: formData.taskTitle, assigned: formData.taskAssigned, startDate: formData.taskStartDate, endDate: formData.taskEndDate, status: formData.taskStatus};
                                    }
                                } else {
                                    const newTask = { id: 't' + Date.now(), title: formData.taskTitle, status: formData.taskStatus || 'todo', assigned: formData.taskAssigned, startDate: formData.taskStartDate, endDate: formData.taskEndDate };
                                    updatedTasks.push(newTask);
                                }
                                await setDoc(projectRef, { tasks: updatedTasks }, { merge: true });
                                updateProjectProgress(project.id);
                            });
                        });
                        break;
                    case 'submissions':
                         document.getElementById('add-submission-btn')?.addEventListener('click', () => {
                             openGenericModal('New Submission', [
                                {label: 'File/Document Name', id: 'subName', type: 'text', required: true},
                                {label: 'Submission Date', id: 'subDate', type: 'date', required: true},
                                {label: 'Status', id: 'subStatus', type: 'select', options: ['Pending', 'Submitted', 'Approved', 'Rejected']},
                                {label: 'Attach File (optional)', id: 'subFile', type: 'file'},
                            ], async (formData, id) => {
                                const projectRef = doc(db, 'artifacts', appId, 'users', state.userId, 'projects', project.id);
                                const updatedSubs = project.submissions ? [...project.submissions] : [];
                                if (id) {
                                     const subIndex = updatedSubs.findIndex(s => s.id === id);
                                     if (subIndex > -1) {
                                         updatedSubs[subIndex].name = formData.subName;
                                         updatedSubs[subIndex].date = formData.subDate;
                                         updatedSubs[subIndex].status = formData.subStatus;
                                         if(formData.subFile.name) updatedSubs[subIndex].fileName = formData.subFile.name;
                                     }
                                } else {
                                    const newSub = { id: 's' + Date.now(), name: formData.subName, date: formData.subDate, status: formData.subStatus, fileName: formData.subFile.name || '' };
                                    updatedSubs.push(newSub);
                                }
                                await setDoc(projectRef, { submissions: updatedSubs }, { merge: true });
                                updateProjectProgress(project.id);
                            });
                        });
                        break;
                    case 'notes':
                        const notesTextarea = document.getElementById('project-notes');
                        notesTextarea?.addEventListener('change', async (e) => {
                            const projectRef = doc(db, 'artifacts', appId, 'users', state.userId, 'projects', project.id);
                            await setDoc(projectRef, { notes: e.target.value }, { merge: true });
                        });
                        break;
                }
            }
            
            function renderProjectOverview(project) {
                const daysLeft = Math.ceil((new Date(project.endDate) - new Date()) / (1000 * 60 * 60 * 24));
                const status = project.progress === 100 ? 'Completed' : (daysLeft < 0 ? 'Overdue' : 'In Progress');
                const statusColor = project.progress === 100 ? 'bg-green-100 text-green-800' : (daysLeft < 0 ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800');

                const el = document.createElement('div');
                el.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Left Column -->
                            <div class="md:col-span-2">
                                <h3 class="font-bold text-lg mb-2 text-gray-800">Project Details</h3>
                                <p class="text-gray-600 mb-6">${project.description || 'No description provided.'}</p>
                                
                                <h3 class="font-bold text-lg mb-2 text-gray-800">Progress</h3>
                                 <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
                                    <div class="bg-indigo-600 h-4 rounded-full text-white text-xs flex items-center justify-center" style="width: ${project.progress}%">
                                        ${project.progress}%
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right Column -->
                            <div class="bg-gray-50 p-4 rounded-md">
                                <h4 class="font-semibold text-gray-700 mb-4">Key Information</h4>
                                <dl>
                                    <div class="flex justify-between py-2 border-b">
                                        <dt class="text-sm text-gray-500">Status</dt>
                                        <dd class="text-sm font-medium text-gray-900"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">${status}</span></dd>
                                    </div>
                                    <div class="flex justify-between py-2 border-b">
                                        <dt class="text-sm text-gray-500">Start Date</dt>
                                        <dd class="text-sm font-medium text-gray-900">${project.startDate}</dd>
                                    </div>
                                    <div class="flex justify-between py-2 border-b">
                                        <dt class="text-sm text-gray-500">End Date</dt>
                                        <dd class="text-sm font-medium text-gray-900">${project.endDate}</dd>
                                    </div>
                                    <div class="flex justify-between py-2">
                                        <dt class="text-sm text-gray-500">Days Remaining</dt>
                                        <dd class="text-sm font-bold ${daysLeft < 0 ? 'text-red-600' : 'text-gray-900'}">${daysLeft >= 0 ? daysLeft : `Overdue by ${Math.abs(daysLeft)}`}</dd>
                                    </div>
                                </dl>
                            </div>
                        </div>
                    </div>
                `;
                return el;
            }
            
            function renderProjectDocumentation(project) {
                const el = document.createElement('div');
                el.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                         <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-gray-800">Project Documents</h3>
                            <button id="add-document-btn" class="bg-indigo-600 text-white px-3 py-1.5 rounded-md text-sm hover:bg-indigo-700">Add Document</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-3 text-left text-sm font-semibold text-gray-600">Name</th>
                                        <th class="p-3 text-left text-sm font-semibold text-gray-600">Type</th>
                                        <th class="p-3 text-left text-sm font-semibold text-gray-600">Date Added</th>
                                        <th class="p-3 text-left text-sm font-semibold text-gray-600">Attachment</th>
                                        <th class="p-3 text-left text-sm font-semibold text-gray-600">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(project.documents || []).map(d => `
                                        <tr class="border-b">
                                            <td class="p-3 text-gray-800">${d.name}</td>
                                            <td class="p-3 text-gray-600">${d.type}</td>
                                            <td class="p-3 text-gray-600">${d.date}</td>
                                            <td class="p-3 text-gray-500 text-sm">${d.fileName || 'None'}</td>
                                            <td class="p-3">
                                                <button class="edit-doc-btn text-indigo-600 hover:underline text-sm" data-id="${d.id}">Edit</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                     ${(!project.documents || project.documents.length === 0) ? `<tr><td colspan="5" class="p-3 text-center text-gray-500">No documents yet.</td></tr>` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                el.querySelectorAll('.edit-doc-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const docId = e.target.dataset.id;
                        const doc = project.documents.find(d => d.id === docId);
                        openGenericModal('Edit Document', [
                            {label: 'Document Name', id: 'docName', type: 'text', required: true, value: doc.name},
                            {label: 'Document Type', id: 'docType', type: 'text', placeholder: 'e.g., Drawing, Report', value: doc.type},
                            {label: 'Date', id: 'docDate', type: 'date', required: true, value: doc.date},
                            {label: `Attach New File (optional, current: ${doc.fileName || 'none'})`, id: 'docFile', type: 'file'},
                        ], async (formData, id) => {
                             const projectRef = doc(db, 'artifacts', appId, 'users', state.userId, 'projects', project.id);
                             const updatedDocs = project.documents.map(d => {
                                if (d.id === id) {
                                    return { ...d, name: formData.docName, type: formData.docType, date: formData.docDate, fileName: formData.docFile.name || d.fileName };
                                }
                                return d;
                             });
                             await setDoc(projectRef, { documents: updatedDocs }, { merge: true });
                        }, docId);
                    });
                });
                return el;
            }
            
            function renderProjectSchedule(project) {
                 const projectStart = new Date(project.startDate).getTime();
                 const projectEnd = new Date(project.endDate).getTime();
                 const totalDuration = Math.max(1, projectEnd - projectStart);

                 const tasksWithOffsets = (project.tasks || []).filter(t => t.startDate && t.endDate).map(task => {
                     const taskStart = new Date(task.startDate).getTime();
                     const taskEnd = new Date(task.endDate).getTime();
                     const offset = ((taskStart - projectStart) / totalDuration) * 100;
                     const width = ((taskEnd - taskStart) / totalDuration) * 100;
                     return {...task, offset: Math.max(0, offset), width: Math.max(0, width)};
                 });

                 const el = document.createElement('div');
                 el.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="font-bold text-lg text-gray-800 mb-4">Project Timeline (Gantt View)</h3>
                        <div class="space-y-4">
                            ${tasksWithOffsets.map(task => `
                                <div class="flex items-center group">
                                    <div class="w-1/4 pr-4">
                                        <p class="text-sm font-medium text-gray-700 truncate">${task.title}</p>
                                    </div>
                                    <div class="w-3/4 bg-gray-200 rounded-full h-6 relative">
                                        <div class="gantt-bar bg-indigo-500 h-6 rounded-full absolute text-white text-xs flex items-center px-2" style="left: ${task.offset}%; width: ${task.width}%; min-width: 20px;">
                                            ${task.title}
                                        </div>
                                    </div>
                                    <div class="w-1/12 pl-2">
                                       <button class="edit-schedule-task-btn opacity-0 group-hover:opacity-100 transition-opacity text-indigo-600 hover:underline text-sm" data-id="${task.id}">Edit</button>
                                    </div>
                                </div>
                            `).join('')}
                            ${tasksWithOffsets.length === 0 ? `<p class="text-center text-gray-500">No tasks with dates to display in schedule.</p>` : ''}
                        </div>
                    </div>
                `;

                el.querySelectorAll('.edit-schedule-task-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const taskId = e.target.dataset.id;
                        const task = project.tasks.find(t => t.id === taskId);
                        openGenericModal('Edit Task', [
                           {label: 'Task Title', id: 'taskTitle', type: 'text', required: true, value: task.title},
                           {label: 'Assigned To', id: 'taskAssigned', type: 'text', value: task.assigned},
                           {label: 'Start Date', id: 'taskStartDate', type: 'date', value: task.startDate},
                           {label: 'End Date', id: 'taskEndDate', type: 'date', value: task.endDate},
                           {label: 'Status', id: 'taskStatus', type: 'select', options: ['todo', 'inprogress', 'done'], value: task.status},
                       ], async (formData, id) => {
                           const projectRef = doc(db, 'artifacts', appId, 'users', state.userId, 'projects', project.id);
                           const updatedTasks = project.tasks.map(t => {
                                if (t.id === id) {
                                    return {...t, ...formData};
                                }
                                return t;
                           });
                           await setDoc(projectRef, { tasks: updatedTasks }, { merge: true });
                           updateProjectProgress(project.id);
                       }, taskId);
                    });
                });

                return el;
            }
            
            function renderProjectProgress(project) {
                const tasks = project.tasks || [];
                const columns = {
                    todo: { title: 'To Do', tasks: tasks.filter(t => t.status === 'todo') },
                    inprogress: { title: 'In Progress', tasks: tasks.filter(t => t.status === 'inprogress') },
                    done: { title: 'Done', tasks: tasks.filter(t => t.status === 'done') },
                };

                const el = document.createElement('div');
                el.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-gray-800">Site Work Progress (Kanban Board)</h3>
                            <button id="add-task-btn" class="bg-indigo-600 text-white px-3 py-1.5 rounded-md text-sm hover:bg-indigo-700">Add Task</button>
                        </div>
                        <div class="flex space-x-4 overflow-x-auto p-2">
                            ${Object.keys(columns).map(key => `
                                <div class="kanban-column bg-gray-100 rounded-lg p-3">
                                    <h4 class="font-semibold text-gray-700 mb-3">${columns[key].title} (${columns[key].tasks.length})</h4>
                                    <div class="space-y-3">
                                        ${columns[key].tasks.map(task => `
                                            <div class="bg-white p-3 rounded-md shadow">
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <p class="font-medium text-gray-800">${task.title}</p>
                                                        <p class="text-xs text-gray-500 mt-1 mb-2">Assigned: ${task.assigned || 'N/A'}</p>
                                                    </div>
                                                    <button class="delete-task-btn text-gray-400 hover:text-red-500 flex-shrink-0" data-id="${task.id}">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                                    </button>
                                                </div>
                                                <select class="task-status-select w-full p-1 border border-gray-300 rounded-md text-xs focus:ring-indigo-500 focus:border-indigo-500" data-id="${task.id}">
                                                    <option value="todo" ${task.status === 'todo' ? 'selected' : ''}>To Do</option>
                                                    <option value="inprogress" ${task.status === 'inprogress' ? 'selected' : ''}>In Progress</option>
                                                    <option value="done" ${task.status === 'done' ? 'selected' : ''}>Done</option>
                                                </select>
                                            </div>
                                        `).join('')}
                                        ${columns[key].tasks.length === 0 ? `<div class="text-sm text-center text-gray-400 p-4">Empty</div>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                el.querySelectorAll('.task-status-select').forEach(select => {
                    select.addEventListener('change', async (e) => {
                        const taskId = e.target.dataset.id;
                        const newStatus = e.target.value;
                        const projectRef = doc(db, 'artifacts', appId, 'users', state.userId, 'projects', project.id);
                        const updatedTasks = project.tasks.map(t => t.id === taskId ? { ...t, status: newStatus } : t);
                        await setDoc(projectRef, { tasks: updatedTasks }, { merge: true });
                        updateProjectProgress(project.id);
                    });
                });
                
                el.querySelectorAll('.delete-task-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const taskId = e.currentTarget.dataset.id;
                        showConfirm('Delete Task?', 'This action cannot be undone.', async () => {
                            const projectRef = doc(db, 'artifacts', appId, 'users', state.userId, 'projects', project.id);
                            const updatedTasks = project.tasks.filter(t => t.id !== taskId);
                            await setDoc(projectRef, { tasks: updatedTasks }, { merge: true });
                            updateProjectProgress(project.id);
                        });
                    });
                });

                return el;
            }
            
            function renderProjectSubmissions(project) {
                const submissions = project.submissions || [];
                const el = document.createElement('div');
                el.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                         <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-gray-800">Client Submissions</h3>
                            <button id="add-submission-btn" class="bg-indigo-600 text-white px-3 py-1.5 rounded-md text-sm hover:bg-indigo-700">Add Submission</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-3 text-left text-sm font-semibold text-gray-600">Document/File</th>
                                        <th class="p-3 text-left text-sm font-semibold text-gray-600">Date</th>
                                        <th class="p-3 text-left text-sm font-semibold text-gray-600">Status</th>
                                        <th class="p-3 text-left text-sm font-semibold text-gray-600">Attachment</th>
                                        <th class="p-3 text-left text-sm font-semibold text-gray-600">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${submissions.map(s => `
                                        <tr class="border-b">
                                            <td class="p-3 text-gray-800">${s.name}</td>
                                            <td class="p-3 text-gray-600">${s.date}</td>
                                            <td class="p-3 text-gray-600">${s.status}</td>
                                            <td class="p-3 text-gray-500 text-sm">${s.fileName || 'None'}</td>
                                            <td class="p-3">
                                                <button class="edit-sub-btn text-indigo-600 hover:underline text-sm" data-id="${s.id}">Edit</button>
                                                <button class="delete-sub-btn text-red-600 hover:underline text-sm ml-2" data-id="${s.id}">Delete</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                     ${submissions.length === 0 ? `<tr><td colspan="5" class="p-3 text-center text-gray-500">No submissions logged.</td></tr>` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                el.querySelectorAll('.edit-sub-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const subId = e.target.dataset.id;
                        const sub = submissions.find(s => s.id === subId);
                        openGenericModal('Edit Submission', [
                            {label: 'File/Document Name', id: 'subName', type: 'text', required: true, value: sub.name},
                            {label: 'Submission Date', id: 'subDate', type: 'date', required: true, value: sub.date},
                            {label: 'Status', id: 'subStatus', type: 'select', options: ['Pending', 'Submitted', 'Approved', 'Rejected'], value: sub.status},
                            {label: `Attach New File (optional, current: ${sub.fileName || 'none'})`, id: 'subFile', type: 'file'},
                        ], async (formData, id) => {
                            const projectRef = doc(db, 'artifacts', appId, 'users', state.userId, 'projects', project.id);
                            const updatedSubs = submissions.map(s => {
                                if(s.id === id) {
                                    return {...s, name: formData.subName, date: formData.subDate, status: formData.subStatus, fileName: formData.subFile.name || s.fileName }
                                }
                                return s;
                            });
                            await setDoc(projectRef, { submissions: updatedSubs }, { merge: true });
                            updateProjectProgress(project.id);
                        }, subId);
                    });
                });

                el.querySelectorAll('.delete-sub-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const subId = e.target.dataset.id;
                        showConfirm('Delete Submission?', 'This action cannot be undone.', async () => {
                            const projectRef = doc(db, 'artifacts', appId, 'users', state.userId, 'projects', project.id);
                            const updatedSubs = submissions.filter(s => s.id !== subId);
                            await setDoc(projectRef, { submissions: updatedSubs }, { merge: true });
                            updateProjectProgress(project.id);
                        });
                    });
                });
                return el;
            }
            
            function renderProjectNotes(project) {
                const el = document.createElement('div');
                 el.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="font-bold text-lg text-gray-800 mb-4">Project Notes</h3>
                        <textarea id="project-notes" rows="10" class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">${project.notes || ''}</textarea>
                    </div>
                `;
                return el;
            }
            
            function renderCalendar() {
                const el = document.createElement('div');
                const today = new Date();
                const month = today.toLocaleString('default', { month: 'long' });
                const year = today.getFullYear();
                
                const events = state.projects.flatMap(p => [
                    { date: p.startDate, name: `${p.name} (Start)`, type: 'start' },
                    { date: p.endDate, name: `${p.name} (End)`, type: 'end' }
                ]).sort((a,b) => new Date(a.date) - new Date(b.date));
                
                el.innerHTML = `
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Calendar - ${month} ${year}</h1>
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="font-semibold text-lg mb-4">Upcoming Project Milestones</h3>
                        <ul class="divide-y divide-gray-200">
                           ${events.map(event => `
                                <li class="py-3 flex items-center">
                                    <div class="w-1/4 text-gray-600">${event.date}</div>
                                    <div class="w-3/4 flex items-center">
                                        <span class="h-2 w-2 rounded-full mr-3 ${event.type === 'start' ? 'bg-green-500' : 'bg-red-500'}"></span>
                                        <span class="font-medium text-gray-800">${event.name}</span>
                                    </div>
                                </li>
                           `).join('')}
                           ${events.length === 0 ? `<li class="py-3 text-center text-gray-500">No upcoming milestones.</li>` : ''}
                        </ul>
                    </div>
                `;
                return el;
            }

            function renderClients() {
                const el = document.createElement('div');
                el.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-800">Clients</h1>
                        <button id="add-client-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md shadow hover:bg-indigo-700 flex items-center">
                            New Client
                        </button>
                    </div>
                    <div class="bg-white rounded-lg shadow-md overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600 whitespace-nowrap">Company Name</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600 whitespace-nowrap">Contact Person</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600 whitespace-nowrap">Email</th>
                                    <th class="p-4 text-left text-sm font-semibold text-gray-600 whitespace-nowrap">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${state.clients.map(c => `
                                    <tr>
                                        <td class="p-4 font-medium text-gray-800">${c.name}</td>
                                        <td class="p-4 text-gray-600">${c.contact}</td>
                                        <td class="p-4 text-gray-600">${c.email}</td>
                                        <td class="p-4 space-x-4">
                                            <button class="edit-client-btn text-indigo-600 hover:underline text-sm" data-id="${c.id}">Edit</button>
                                            <button class="delete-client-btn text-red-600 hover:underline text-sm" data-id="${c.id}">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                                ${state.clients.length === 0 ? `<tr><td colspan="4" class="text-center p-4 text-gray-500">No clients added yet.</td></tr>` : ''}
                            </tbody>
                        </table>
                    </div>
                `;
                el.querySelector('#add-client-btn').addEventListener('click', () => {
                     openGenericModal('New Client', [
                        {label: 'Company Name', id: 'clientName', type: 'text', required: true},
                        {label: 'Contact Person', id: 'clientContact', type: 'text'},
                        {label: 'Email', id: 'clientEmail', type: 'email'},
                    ], async (formData) => {
                        const newClient = { name: formData.clientName, contact: formData.clientContact, email: formData.clientEmail };
                        await addDoc(collection(db, 'artifacts', appId, 'users', state.userId, 'clients'), newClient);
                    });
                });
                
                el.querySelectorAll('.edit-client-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const clientId = e.target.dataset.id;
                        const client = state.clients.find(c => c.id === clientId);
                        openGenericModal('Edit Client', [
                            {label: 'Company Name', id: 'clientName', type: 'text', required: true, value: client.name},
                            {label: 'Contact Person', id: 'clientContact', type: 'text', value: client.contact},
                            {label: 'Email', id: 'clientEmail', type: 'email', value: client.email},
                        ], async (formData, id) => {
                            const clientRef = doc(db, 'artifacts', appId, 'users', state.userId, 'clients', id);
                            await setDoc(clientRef, { name: formData.clientName, contact: formData.clientContact, email: formData.clientEmail }, { merge: true });
                        }, clientId);
                    });
                });

                el.querySelectorAll('.delete-client-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const clientId = e.target.dataset.id;
                        showConfirm('Delete Client?', 'Deleting a client will remove them from all projects. This cannot be undone.', async () => {
                            const clientRef = doc(db, 'artifacts', appId, 'users', state.userId, 'clients', clientId);
                            await deleteDoc(clientRef);
                            
                            // Remove client from associated projects
                            const batch = writeBatch(db);
                            state.projects.forEach(p => {
                                if (p.clientId === clientId) {
                                    const projectRef = doc(db, 'artifacts', appId, 'users', state.userId, 'projects', p.id);
                                    batch.update(projectRef, { clientId: "" });
                                }
                            });
                            await batch.commit();
                        });
                    });
                });

                return el;
            }

            // --- MODALS ---
            const projectModal = document.getElementById('project-modal');
            const projectForm = document.getElementById('project-form');

            function openProjectModal(projectId = null) {
                projectForm.reset();
                document.getElementById('projectId').value = '';
                
                const clientSelect = document.getElementById('projectClient');
                clientSelect.innerHTML = '<option value="">-- No Client --</option>' + state.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

                if (projectId) {
                    const project = state.projects.find(p => p.id === projectId);
                    document.getElementById('modal-title').innerText = 'Edit Project';
                    document.getElementById('projectId').value = project.id;
                    document.getElementById('projectName').value = project.name;
                    document.getElementById('projectClient').value = project.clientId;
                    document.getElementById('startDate').value = project.startDate;
                    document.getElementById('endDate').value = project.endDate;
                    document.getElementById('projectDescription').value = project.description;
                } else {
                    document.getElementById('modal-title').innerText = 'New Project';
                }
                projectModal.classList.remove('hidden');
            }

            function closeProjectModal() {
                projectModal.classList.add('hidden');
            }

            document.getElementById('cancel-project').addEventListener('click', closeProjectModal);
            projectForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('projectId').value;
                const projectData = {
                    name: document.getElementById('projectName').value,
                    clientId: document.getElementById('projectClient').value,
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    description: document.getElementById('projectDescription').value,
                };
                
                if (id) { // Editing
                    const projectRef = doc(db, 'artifacts', appId, 'users', state.userId, 'projects', id);
                    await setDoc(projectRef, projectData, { merge: true });
                } else { // Creating
                    const newProject = {
                        ...projectData,
                        progress: 0,
                        documents: [], tasks: [], submissions: [], notes: '',
                    };
                    await addDoc(collection(db, 'artifacts', appId, 'users', state.userId, 'projects'), newProject);
                }
                closeProjectModal();
            });

            // Generic Modal
            const genericModal = document.getElementById('generic-modal');
            const genericForm = document.getElementById('generic-form');
            let genericCallback = null;
            
            function openGenericModal(title, fields, callback, editId = null) {
                genericForm.reset();
                document.getElementById('generic-modal-title').innerText = title;
                document.getElementById('generic-edit-id').value = editId || '';
                document.getElementById('generic-submit-btn').innerText = editId ? 'Save Changes' : 'Add';
                
                const body = document.getElementById('generic-modal-body');
                body.innerHTML = fields.map(f => {
                    const value = f.value || '';
                    if (f.type === 'select') {
                       return `
                            <div class="mb-4">
                                <label for="${f.id}" class="block text-sm font-medium text-gray-700">${f.label}</label>
                                <select id="${f.id}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    ${f.options.map(opt => `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt.charAt(0).toUpperCase() + opt.slice(1)}</option>`).join('')}
                                </select>
                            </div>
                       `;
                    }
                     if (f.type === 'file') {
                        return `
                        <div class="mb-4">
                            <label for="${f.id}" class="block text-sm font-medium text-gray-700">${f.label}</label>
                            <input type="file" id="${f.id}" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        </div>
                    `;
                    }
                    return `
                        <div class="mb-4">
                            <label for="${f.id}" class="block text-sm font-medium text-gray-700">${f.label}</label>
                            <input type="${f.type}" id="${f.id}" ${f.required ? 'required' : ''} value="${value}" placeholder="${f.placeholder || ''}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    `;
                }).join('');
                genericCallback = callback;
                genericModal.classList.remove('hidden');
            }
            
            function closeGenericModal() {
                genericModal.classList.add('hidden');
                genericCallback = null;
            }
            
            document.getElementById('cancel-generic').addEventListener('click', closeGenericModal);
            genericForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const editId = document.getElementById('generic-edit-id').value;
                const data = {};
                e.target.querySelectorAll('input, select').forEach(input => {
                    if (input.type === 'file') {
                        data[input.id] = input.files[0] || { name: '' }; // Store file object or empty name
                    } else {
                        data[input.id] = input.value;
                    }
                });
                
                if (genericCallback) {
                    genericCallback(data, editId);
                }
                closeGenericModal();
            });

            // --- Custom Confirm Modal ---
            const confirmModal = document.getElementById('confirm-modal');
            let confirmCallback = null;
            
            function showConfirm(title, text, callback) {
                document.getElementById('confirm-modal-title').innerText = title;
                document.getElementById('confirm-modal-text').innerText = text;
                confirmCallback = callback;
                confirmModal.classList.remove('hidden');
            }
            
            document.getElementById('confirm-cancel-btn').addEventListener('click', () => {
                confirmModal.classList.add('hidden');
                confirmCallback = null;
            });
            
            document.getElementById('confirm-ok-btn').addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                confirmModal.classList.add('hidden');
                confirmCallback = null;
            });

            // --- SIDEBAR ---
            const sidebar = document.getElementById('sidebar');
            document.getElementById('toggleSidebar').addEventListener('click', () => {
                state.sidebarCollapsed = !state.sidebarCollapsed;
                sidebar.classList.toggle('collapsed', state.sidebarCollapsed);
            });
            
            sidebar.classList.toggle('collapsed', state.sidebarCollapsed);
            
            // --- INITIALIZATION ---
            initializeFirebase();
        });
    </script>
</body>
</html>


